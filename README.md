# browser
浏览器-性能分析与优化

# chrome 进程
- 浏览器主进程 负责界面显示 用户交互 子进程管理 
- 渲染进程 排版 JSV8 都在这层，负责把HTML和CSS 和JS转变成网页
- 网络进程 加载网络资源
- GPU进程 加速页面生成

# 渲染流水线
- 1. 渲染进程把HTML转化为DOM树型结构
- 2. 渲染进程把CSS文本转为浏览器中的stylesheet
- 3. 通过stylesheet计算出DOM节点的样式
- 4. 根据DOM树创建布局树
- 5. 并计算各个元素的布局信息
- 6. 根据布局树生成分层树
- 7. 根据分层树进行生成绘制步骤
- 8. 把绘制步骤交给渲染进程中的合成线程进行合成
- 9. 合成线程将图层分成图块（tile）
- 10. 合成线程会把分好的图块发给栅格化线程池，栅格化线程会把图片（tile）转化为位图
- 11. 而其实栅格化线程在工作的时候会把栅格化的工作交给GPU进程来完成，最终生成的位图就保存在了GPU内存中国呢
- 12. 当所有的图块都光栅化之后合成线程就会发生绘制图块的命令给浏览器主进程
- 13. 浏览器主进程然后会从CPU内存中取出位图显示到页面上

## HTML转化为DOM树型
- 浏览器中的HTML解析器可以把HTML字符串转化成DOM结构
- HTML解析器边接收网络数据边解析HTML
- 解析DOM
    - HTML字符串Token
    - Token栈用了维护节点之间的父子关系，Token会依次压入栈中
    - 如果是开始标签，把Token压入栈中并且创建新的DOM节点并添加到父节点的children中
    - 如果是文本Token，则把文本节点添加到栈顶元素的children中，文本Token不需要入栈
    - 如果是结束标签，此开始标签出栈
## CSS 转stylesheet
- 渲染进程把css文本转化为浏览器中的stylesheet
- css来源可能有link标签、style标签和style行内样式
- 渲染引擎会把css转换 document.styleSheets

## 计算出DOM节点的样式
- 根据css的继承和层叠规则计算DOM节点的样式
- DOM节点的样式保存在了ComputedStyle（计算出的样式）中


## 问题
- buffer 固定长度不一定的话 parser接收解析到的一个丢失的内容 如：< div > <p
- parser 内部会进行凸显
- 例如：第一次获取数据 ： < div > <p
    只解析<div>
    缓存<p
    等待下次再获取数据的时候和上次缓存的<p 合在一起解析

## 创建布局树
- 创建布局树
- 创建一颗只包含可见元素的布局树
https://www.processon.com/diagraming/61d9d245e401fd06a8be45a4

## 计算布局
- 计算各个元素的布局
- https://www.processon.com/diagraming/61d9d245e401fd06a8be45a4
- layout.top=top(自己距离自己父节点顶部距离)+parentTop(父节点居顶部距离)

## 生成分层树
- 根据布局树生成分层树
- 渲染引擎需要为某些节点生成单独的图层，并组合成图层树
    - z-index
    - 绝对定位和固定定位
    - 滤镜
    - 透明
    - 裁剪
- 这些图层合成最终页面

## 绘制
- 根据分层树进行生成绘制步骤复合图层
- 每个图层会拆分成多个绘制指令，这些指令组合在一起成为绘制列表

## 合成线程
- 合成线程将图层分成图块（tile）
- 合成线程会把分好的图块发给栅格化线程池
- 合成线程会把分好的图块发给栅格化线程池，栅格化线程会把图片（tile）转化为位图
- 而其实栅格化线程在工作的时候会把栅格化的工作交给GPU进程来完成，最终生成的位图就保存在了GPU内存中国呢
- 当所有的图块都光栅化之后合成线程就会发生绘制图块的命令给浏览器主进程
- 浏览器主进程然后会从CPU内存中取出位图显示到页面上
